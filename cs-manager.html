<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CS代肝管理系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .empty-state{text-align:center;padding:4rem 0;color:#9CA3AF}
        .empty-state i{font-size:2rem;margin-bottom:1rem;opacity:.5}
        .stat-icon{width:2.5rem;height:2.5rem;display:flex;align-items:center;justify-content:center;border-radius:50%}
        .progress-bar{height:4px;background-color:#E5E7EB;border-radius:2px;margin-top:.5rem;overflow:hidden}
        .progress-value{height:100%;transition:width .3s ease}
        .modal-enter{opacity:0;transform:scale(.95)}
        .modal-enter-active{opacity:1;transform:scale(1);transition:opacity 300ms,transform 300ms}
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
<header class="bg-white border-b border-gray-200 sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-xl md:text-2xl font-bold text-gray-800 flex items-center">
            <i class="fa fa-gamepad text-blue-500 mr-2"></i>CS代肝管理系统
        </h1>
        <div class="flex items-center gap-4">
            <span id="current-date" class="text-sm text-gray-500"></span>
            <button id="export-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex items-center transition duration-200">
                <i class="fa fa-download mr-2"></i>导出数据
            </button>
        </div>
    </div>
</header>

<main class="container mx-auto px-4 py-6 space-y-6">
    <div class="bg-white rounded-lg shadow p-4">
        <div class="relative">
            <input id="search-input" type="text" placeholder="输入关键词搜索..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        </div>
    </div>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white rounded-lg shadow p-5 flex justify-between items-start">
            <div>
                <div class="text-sm text-gray-500">总任务数</div>
                <div id="total-tasks" class="text-3xl font-bold text-gray-800 mt-1">0</div>
                <div class="progress-bar"><div class="progress-value bg-blue-400" style="width:0%"></div></div>
            </div>
            <div class="stat-icon bg-blue-100 text-blue-600"><i class="fa fa-tasks"></i></div>
        </div>
        <div class="bg-white rounded-lg shadow p-5 flex justify-between items-start">
            <div>
                <div class="text-sm text-gray-500">已完成任务数</div>
                <div id="finished-tasks" class="text-3xl font-bold text-gray-800 mt-1">0</div>
                <div class="progress-bar"><div class="progress-value bg-green-400" style="width:0%"></div></div>
            </div>
            <div class="stat-icon bg-green-100 text-green-600"><i class="fa fa-check"></i></div>
        </div>
        <div class="bg-white rounded-lg shadow p-5 flex justify-between items-start">
            <div>
                <div class="text-sm text-gray-500">未完成任务数</div>
                <div id="unfinished-tasks" class="text-3xl font-bold text-gray-800 mt-1">0</div>
                <div class="progress-bar"><div class="progress-value bg-yellow-400" style="width:0%"></div></div>
            </div>
            <div class="stat-icon bg-yellow-100 text-yellow-600"><i class="fa fa-clock-o"></i></div>
        </div>
    </section>

    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-4 border-b border-gray-100 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
                <h2 class="text-lg font-semibold text-gray-800">任务管理列表</h2>
                <p class="text-xs text-gray-500 mt-1 flex items-center"><i class="fa fa-info-circle mr-1"></i>每周三10点自动重置完成状态</p>
            </div>
            <button id="add-task-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex items-center transition duration-200 self-start">
                <i class="fa fa-plus mr-2"></i>添加任务
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                <tr>
                    <th class="px-4 py-3 text-left">序号</th>
                    <th class="px-4 py-3 text-left">咸鱼</th>
                    <th class="px-4 py-3 text-left">微信</th>
                    <th class="px-4 py-3 text-left">剩余次数</th>
                    <th class="px-4 py-3 text-left">本周是否完成</th>
                    <th class="px-4 py-3 text-left">备注</th>
                    <th class="px-4 py-3 text-left">操作</th>
                </tr>
                </thead>
                <tbody id="task-tbody">
                <tr>
                    <td colspan="7" class="empty-state"><i class="fa fa-folder-open-o"></i><p>暂无任务，请点击"添加任务"按钮创建新任务</p></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- 添加/编辑任务弹窗 -->
<div id="task-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 modal-enter">
        <form id="task-form" class="p-6 space-y-4">
            <h3 class="text-lg font-semibold text-gray-800">添加任务</h3>
            <input type="hidden" id="task-id">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">咸鱼</label>
                <input id="fish" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">微信</label>
                <input id="wechat" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">剩余次数</label>
                <input id="remain" type="number" min="0" value="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">本周是否完成</label>
                <select id="done" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    <option value="否">否</option>
                    <option value="是">是</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">备注</label>
                <textarea id="note" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"></textarea>
            </div>
            <div class="flex justify-end gap-2 pt-2">
                <button type="button" id="cancel-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200">取消</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">保存</button>
            </div>
        </form>
    </div>
</div>

<script>
const STORAGE_KEY='csTasks';
let tasks=JSON.parse(localStorage.getItem(STORAGE_KEY))||[];
let currentEditId=null;
function $(id){return document.getElementById(id)}
function initDate(){
    const d=new Date().toLocaleDateString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'}).replace(/\//g,'-').replace('星期',' 星期');
    $('current-date').textContent=d;
}
function saveTasks(){localStorage.setItem(STORAGE_KEY,JSON.stringify(tasks))}
function autoResetTasks(){
    const now=new Date(),day=now.getDay(),hour=now.getHours(),today=now.toISOString().split('T')[0],last=localStorage.getItem('lastResetDate');
    if(day===3&&hour>=10&&last!==today){tasks.forEach(t=>t.done='否');saveTasks();localStorage.setItem('lastResetDate',today);renderTasks();}
}
function renderTasks(filtered=null){
    const list=filtered||tasks,tbody=$('task-tbody');
    tbody.innerHTML=list.length?list.map((t,i)=>`
        <tr class="border-t border-gray-100 hover:bg-gray-50 transition duration-100">
            <td class="px-4 py-3">${i+1}</td>
            <td class="px-4 py-3">${t.fish}</td>
            <td class="px-4 py-3">${t.wechat||'-'}</td>
            <td class="px-4 py-3">${t.remain}</td>
            <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs ${t.done==='是'?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'}">${t.done}</span></td>
            <td class="px-4 py-3">${t.note||'-'}</td>
            <td class="px-4 py-3">
                <button class="text-blue-600 hover:text-blue-800 mr-3 text-sm" onclick="editTask('${t.id}')"><i class="fa fa-pencil mr-1"></i>编辑</button>
                <button class="text-red-600 hover:text-red-800 text-sm" onclick="deleteTask('${t.id}')"><i class="fa fa-trash mr-1"></i>删除</button>
                <button class="text-green-600 hover:text-green-800 text-sm ml-2" onclick="finishWeek('${t.id}')"><i class="fa fa-check-circle mr-1"></i>完成本周</button>
            </td>
        </tr>`).join('')
        :`<tr><td colspan="7" class="empty-state"><i class="fa fa-folder-open-o"></i><p>暂无任务，请点击"添加任务"按钮创建新任务</p></td></tr>`;
    updateStatistics();
}
function updateStatistics(){
    const total=tasks.length,finished=tasks.filter(t=>t.done==='是').length,unfinished=total-finished;
    $('total-tasks').textContent=total;
    $('finished-tasks').textContent=finished;
    $('unfinished-tasks').textContent=unfinished;
    document.querySelectorAll('.progress-value')[0].style.width=total>0?`${(total/Math.max(total,10))*100}%`:0;
    document.querySelectorAll('.progress-value')[1].style.width=total>0?`${(finished/total)*100}%`:0;
    document.querySelectorAll('.progress-value')[2].style.width=total>0?`${(unfinished/total)*100}%`:0;
}
function openTaskModal(task=null){
    $('task-form').reset();
    currentEditId=null;$('task-id').value='';
    if(task){currentEditId=task.id;$('task-id').value=task.id;$('fish').value=task.fish;$('wechat').value=task.wechat||'';$('remain').value=task.remain;$('done').value=task.done;$('note').value=task.note||'';document.querySelector('#task-form h3').textContent='编辑任务';}
    else{document.querySelector('#task-form h3').textContent='添加任务';}
    $('task-modal').classList.remove('hidden');$('task-modal').classList.add('flex');
    setTimeout(()=>{$('modal-content').classList.remove('modal-enter');$('modal-content').classList.add('modal-enter-active');},10);
}
function closeTaskModal(){
    const m=$('modal-content');
    m.classList.remove('modal-enter-active');m.classList.add('modal-enter');
    setTimeout(()=>{$('task-modal').classList.add('hidden');$('task-modal').classList.remove('flex');},300);
}
function addTask(data){
    tasks.push({id:Date.now().toString(),...data});saveTasks();renderTasks();
}
function editTask(id){const t=tasks.find(x=>x.id===id);if(t)openTaskModal(t);}
function updateTask(id,data){const i=tasks.findIndex(x=>x.id===id);if(i>-1){tasks[i]={...tasks[i],...data};saveTasks();renderTasks();}}
function deleteTask(id){if(confirm('确定要删除这个任务吗？')){tasks=tasks.filter(t=>t.id!==id);saveTasks();renderTasks();}}
function finishWeek(id){
    const t=tasks.find(x=>x.id===id);
    if(!t)return;
    if(t.done==='是'){alert('本周已完成，无需重复操作');return;}
    t.done='是';
    t.remain=Math.max(0,(t.remain||0)-1);
    saveTasks();renderTasks();
}
function searchTasks(kw){
    if(!kw){renderTasks();return;}
    const f=tasks.filter(t=>(t.fish&&t.fish.toLowerCase().includes(kw.toLowerCase()))||(t.wechat&&t.wechat.toLowerCase().includes(kw.toLowerCase()))||(t.note&&t.note.toLowerCase().includes(kw.toLowerCase())));
    renderTasks(f);
}
function exportData(){
    if(!tasks.length){alert('没有数据可导出');return;}
    const h=['序号','咸鱼','微信','剩余次数','本周是否完成','备注'],rows=[h];
    tasks.forEach((t,i)=>rows.push([i+1,`"${t.fish||''}"`,`"${t.wechat||''}"`,t.remain,`"${t.done}"`,`"${t.note||''}"`]));
    const csv=rows.map(r=>r.join(',')).join('\n'),blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'}),url=URL.createObjectURL(blob),a=document.createElement('a');
    a.href=url;a.download=`CS代肝任务数据_${new Date().toISOString().split('T')[0]}.csv`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
}
window.editTask=editTask;window.deleteTask=deleteTask;window.finishWeek=finishWeek;

function init(){
    initDate();autoResetTasks();renderTasks();
    $('add-task-btn').addEventListener('click',()=>openTaskModal());
    $('cancel-btn').addEventListener('click',closeTaskModal);
    $('export-btn').addEventListener('click',exportData);
    $('search-input').addEventListener('input',e=>searchTasks(e.target.value.trim()));
    $('task-form').addEventListener('submit',e=>{
        e.preventDefault();
        const data={fish:$('fish').value.trim(),wechat:$('wechat').value.trim(),remain:parseInt($('remain').value)||0,done:$('done').value,note:$('note').value.trim()};
        if(!data.fish&&!data.wechat){alert('咸鱼或微信至少填写一项');return;}
        currentEditId?updateTask(currentEditId,data):addTask(data);closeTaskModal();
    });
}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>